---
# PreSync hook: gather OpenShift default domain and store as application PARAM (ConfigMap ingress-domain).
# Domain: kubectl get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}'
# The kustomization that runs as part of the Argo CD deployment uses this ConfigMap as var and
# patches the Ingress host via replacements. PreSync runs first so the cluster has the value
# before the main sync applies (repo ConfigMap may overwrite; use overlay to keep cluster domain).
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-server-domain-prehook
  namespace: couchbase
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: grafana
        argocd.argoproj.io/hook: "true"
    spec:
      serviceAccountName: grafana-server-domain-hook
      restartPolicy: OnFailure
      containers:
        - name: get-domain
          image: registry.k8s.io/kubectl:latest
          command:
            - /bin/sh
            - -ec
            - |
              if kubectl get configmap ingress-domain -n couchbase &>/dev/null; then
                echo "ConfigMap ingress-domain already exists, skipping"
                exit 0
              fi
              DOMAIN=$(kubectl get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}')
              if [ -z "$DOMAIN" ]; then
                echo "ERROR: could not get OpenShift ingress domain"
                exit 1
              fi
              HOST="grafana.$DOMAIN"
              kubectl create configmap ingress-domain \
                --from-literal=domain="$DOMAIN" \
                --from-literal=host="$HOST" \
                --namespace=couchbase \
                --dry-run=client -o yaml | kubectl apply -f -
              echo "Stored domain (application PARAM): $DOMAIN, host: $HOST"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL

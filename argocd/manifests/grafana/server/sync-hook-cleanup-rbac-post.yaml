---
# PostSync hook: remove the extra rbac-domain-hook (PreSync hook RBAC) so it does not persist in the cluster.
# Uses persistent RBAC from rbac-cleanup.yaml. Delete bindings first, then roles, then ServiceAccount.
apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-server-cleanup-rbac-posthook
  namespace: couchbase
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: grafana
        argocd.argoproj.io/hook: "true"
    spec:
      serviceAccountName: grafana-server-rbac-cleanup
      restartPolicy: OnFailure
      containers:
        - name: cleanup-rbac
          image: registry.k8s.io/kubectl:latest
          command:
            - /bin/sh
            - -ec
            - |
              set -e
              NS=couchbase
              kubectl delete clusterrolebinding grafana-server-domain-reader --ignore-not-found=true
              kubectl delete rolebinding grafana-server-domain-hook -n "$NS" --ignore-not-found=true
              kubectl delete clusterrole grafana-server-domain-reader --ignore-not-found=true
              kubectl delete role grafana-server-domain-hook -n "$NS" --ignore-not-found=true
              kubectl delete serviceaccount grafana-server-domain-hook -n "$NS" --ignore-not-found=true
              echo "Cleaned up rbac-domain-hook resources"
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
---
# PreSync: create or patch Argo CD cluster Secret for the in-cluster, with ingress subdomain.
# The Secret is an Argo CD cluster secret (argocd.argoproj.io/secret-type: cluster) so the
# ApplicationSet can generate one Application for this cluster. Subdomain is stored in the
# same Secret (ingress-domain) for the grafana-server PostSync to patch the Ingress host.
apiVersion: batch/v1
kind: Job
metadata:
  name: cluster-configuration-prehook
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: argocd-main
        argocd.argoproj.io/hook: "true"
    spec:
      serviceAccountName: cluster-configuration-hook
      restartPolicy: OnFailure
      containers:
        - name: get-ingress-domain
          # Use an image that includes /bin/sh (official kubectl image is distroless).
          image: registry.redhat.io/openshift4/ose-cli-rhel9:v4.21
          command:
            - /bin/sh
            - -ec
            - |
              DOMAIN=$(kubectl get ingresses.config.openshift.io cluster -o jsonpath='{.spec.domain}' 2>/dev/null) || true
              [ -z "$DOMAIN" ] && echo "Error: No ingress domain found" && exit 1
              # Argo CD cluster secret for in-cluster (name, server). Annotation ingress-domain
              # is used by grafana-server ApplicationSet kustomize patches to set Ingress host.
              SECRET_NAME="openshift-gitops-cluster-configuration"
              cat <<EOF | sed 's/^              //' | kubectl apply -n openshift-gitops -f -
              apiVersion: v1
              kind: Secret
              metadata:
                name: ${SECRET_NAME}
                labels:
                  argocd.argoproj.io/secret-type: cluster
                  argocd.argoproj.io/cluster-name: in-cluster
                annotations:
                  ingress-domain: "${DOMAIN}"
              type: Opaque
              stringData:
                name: in-cluster
                server: https://kubernetes.default.svc
              EOF

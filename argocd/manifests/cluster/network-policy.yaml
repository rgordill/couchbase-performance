---
# Network Policy for Couchbase Cluster
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: couchbase-cluster
  namespace: couchbase
spec:
  podSelector:
    matchLabels:
      app: couchbase
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from same namespace
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8091  # Admin
        - protocol: TCP
          port: 8092  # Views
        - protocol: TCP
          port: 8093  # Query
        - protocol: TCP
          port: 8094  # FTS
        - protocol: TCP
          port: 8095  # Analytics
        - protocol: TCP
          port: 8096  # Eventing
        - protocol: TCP
          port: 9102  # Metrics
        - protocol: TCP
          port: 11210 # Data
        - protocol: TCP
          port: 11207 # Data SSL
    # Allow from OpenShift monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              openshift.io/cluster-monitoring: "true"
        - namespaceSelector:
            matchLabels:
              name: openshift-user-workload-monitoring
      ports:
        - protocol: TCP
          port: 9102  # Metrics
    # Allow from application namespaces (add your app namespaces here)
    - from:
        - namespaceSelector:
            matchLabels:
              app-access: "allowed"
      ports:
        - protocol: TCP
          port: 11210
        - protocol: TCP
          port: 11207
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: openshift-dns
      ports:
        - protocol: UDP
          port: 5353
    # Allow to same namespace
    - to:
        - podSelector: {}
    # Allow to kube-apiserver
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
      ports:
        - protocol: TCP
          port: 443
    # Allow outbound for XDCR
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 8091
        - protocol: TCP
          port: 11210

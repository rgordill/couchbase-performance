# Couchbase Performance Testing Client (cbc-pillowfight)
# Pre-built libcouchbase from https://github.com/couchbase/libcouchbase/releases/
# Tarball: libcouchbase-<version>_<os>_<arch>.tar (contains RPMs; install via rpm).
# Base UBI 9 to match EL9 RPMs (OpenSSL 1.1); UBI 10 does not provide compat-libssl11.

ARG version=3.3.18
ARG os=rhel9
ARG arch=x86_64

FROM registry.access.redhat.com/ubi9-minimal:9.7

# Install runtime deps + curl/tar/rpm for download and RPM install
RUN microdnf install -y \
    libevent \
    # openssl \
    # curl \
    tar \
    # rpm \
    compat-openssl11 \
    && microdnf clean all \
    && rm -rf /var/cache/yum

# Download tarball, extract, install libcouchbase RPMs (tarball contains RPMs not a dir tree)
ARG version
ARG os
ARG arch
RUN set -eux; \
    tar="libcouchbase-${version}_${os}_${arch}.tar"; \
    curl -sSLf -o /tmp/lcb.tar \
        "https://github.com/couchbase/libcouchbase/releases/download/${version}/${tar}"; \
    tar -xf /tmp/lcb.tar -C /tmp; \
    d="/tmp/libcouchbase-${version}_${os}_${arch}"; \
    rel="el${os#rhel}"; \
    rpm -Uvh --nodeps \
      "$d"/libcouchbase3-${version}-1.${rel}.x86_64.rpm \
      "$d"/libcouchbase3-tools-${version}-1.${rel}.x86_64.rpm \
      "$d"/libcouchbase3-libevent-${version}-1.${rel}.x86_64.rpm; \
    rm -rf /tmp/lcb.tar "$d"; \
    microdnf remove -y tar && microdnf clean all

# Metadata
LABEL name="cbc-pillowfight" \
      version="${version}" \
      summary="Couchbase Performance Testing Client" \
      description="Container with cbc-pillowfight from pre-built libcouchbase (RHEL/EL)" \
      maintainer="rgordill@redhat.com" \
      io.k8s.description="Couchbase performance testing client with cbc-pillowfight" \
      io.k8s.display-name="Couchbase PerfTest" \
      io.openshift.tags="couchbase,performance,testing"

# Run as non-root
USER 1001

# Default command - show help
CMD ["cbc-pillowfight", "--help"]

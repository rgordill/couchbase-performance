# Couchbase Performance Testing Client (cbc-pillowfight)
# Works with: podman, docker, buildah, nerdctl

ARG UBI_VERSION=9.3
ARG BUILD_DATE
ARG VCS_REF

# Build stage
FROM registry.access.redhat.com/ubi9/ubi-minimal:${UBI_VERSION} AS builder

# Install build dependencies
RUN microdnf install -y \
    gcc \
    gcc-c++ \
    make \
    cmake \
    git \
    libevent-devel \
    openssl-devel \
    && microdnf clean all

WORKDIR /build

# Clone and build libcouchbase
ARG LIBCOUCHBASE_VERSION=3.3.12
RUN git clone --branch ${LIBCOUCHBASE_VERSION} --depth 1 \
    https://github.com/couchbase/libcouchbase.git \
    && cd libcouchbase \
    && mkdir build \
    && cd build \
    && cmake \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr/local \
        .. \
    && make -j$(nproc) \
    && make install

# Final stage - UBI Minimal
FROM registry.access.redhat.com/ubi9/ubi-minimal:${UBI_VERSION}

# Metadata
LABEL name="couchbase-perftest-client" \
      version="3.3.12" \
      summary="Couchbase Performance Testing Client" \
      description="Container with cbc-pillowfight and other Couchbase performance testing tools" \
      maintainer="couchbase-performance@example.com" \
      vendor="Couchbase Performance Team" \
      build-date="${BUILD_DATE}" \
      vcs-ref="${VCS_REF}" \
      io.k8s.description="Couchbase performance testing client with cbc-pillowfight" \
      io.k8s.display-name="Couchbase PerfTest" \
      io.openshift.tags="couchbase,performance,testing"

# Install runtime dependencies
RUN microdnf install -y \
    libevent \
    openssl \
    && microdnf clean all \
    && rm -rf /var/cache/yum

# Copy libcouchbase binaries and libraries from builder
COPY --from=builder /usr/local/bin/cbc* /usr/local/bin/
COPY --from=builder /usr/local/lib64/libcouchbase* /usr/local/lib64/
COPY --from=builder /usr/local/lib/libcouchbase* /usr/local/lib/ 2>/dev/null || true

# Update library cache
RUN echo "/usr/local/lib64" > /etc/ld.so.conf.d/libcouchbase.conf \
    && ldconfig

# Create scripts directory
WORKDIR /scripts
COPY --chown=1001:0 scripts/ /scripts/

# Set environment variables
ENV PATH=/usr/local/bin:$PATH \
    LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:$LD_LIBRARY_PATH

# Run as non-root
USER 1001

# Default command - show help
CMD ["cbc-pillowfight", "--help"]
